<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avis de Passage - Nett'Ovation</title>
    <style>
        /* Styles précédents inchangés */
    </style>
</head>
<body>
    <h1>Avis de Passage - <span id="clientName"></span></h1>
    
    <div class="section">
        <h2>Ajouter un avis de passage</h2>
        <form id="avisForm">
            <input type="date" id="date" required>
            <input type="time" id="heureDebut" required>
            <input type="time" id="heureFin" required>
            <textarea id="observations" placeholder="Observations" required></textarea>
            <input type="text" id="intervenant" placeholder="Nom de l'intervenant" required>
            <select id="typeIntervention" required>
                <option value="">Choisir le type d'intervention</option>
                <option value="prochaine">Prochaine intervention</option>
                <option value="aPrevoir">À prévoir</option>
            </select>
            <input type="datetime-local" id="dateIntervention">
            <button type="submit">Ajouter l'avis</button>
        </form>
    </div>

    <div class="section">
        <h2>Historique des avis</h2>
        <div id="avisList"></div>
    </div>

    <div class="footer">
        <p>Nett'Ovation - Le nettoyage à la hauteur de vos attentes !</p>
        <p>Contact : <a href="mailto:info@nett-ovation.fr">info@nett-ovation.fr</a> | Tél : 07 82 03 05 02</p>
    </div>

    <script>
        function getClientId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('client');
        }

        function getClientInfo(clientId) {
            const clients = JSON.parse(localStorage.getItem('clients')) || [];
            return clients.find(client => client.id === clientId);
        }

        function loadAvis() {
            const clientId = getClientId();
            const client = getClientInfo(clientId);
            if (!client) {
                alert("Client non trouvé");
                return;
            }

            document.getElementById('clientName').textContent = client.nomPrenom;

            let avis = JSON.parse(localStorage.getItem(`avis_${clientId}`)) || [];
            const avisList = document.getElementById('avisList');
            avisList.innerHTML = '';

            // Trier les avis par date, du plus récent au plus ancien
            avis.sort((a, b) => new Date(b.date) - new Date(a.date));

            const now = new Date();
            let prochaineIntervention = null;
            let interventionAPrevoir = false;

            avis.forEach(a => {
                const avisElement = document.createElement('div');
                avisElement.className = 'avis';

                const dateIntervention = new Date(a.date);

                if (a.typeIntervention === 'prochaine' && a.dateIntervention) {
                    const dateProchaineIntervention = new Date(a.dateIntervention);
                    if (dateProchaineIntervention > now && (!prochaineIntervention || dateProchaineIntervention < prochaineIntervention)) {
                        prochaineIntervention = dateProchaineIntervention;
                    }
                } else if (a.typeIntervention === 'aPrevoir') {
                    interventionAPrevoir = true;
                }

                avisElement.innerHTML = `
                    <h3>Intervention du ${dateIntervention.toLocaleDateString()}</h3>
                    <p>Heure de début : ${a.heureDebut}</p>
                    <p>Heure de fin : ${a.heureFin}</p>
                    <p>Observations : ${a.observations}</p>
                    <p>Intervenant : ${a.intervenant}</p>
                    <p>${a.typeIntervention === 'prochaine' ? 'Prochaine intervention prévue' : 'Intervention à prévoir'} : 
                       ${a.dateIntervention ? new Date(a.dateIntervention).toLocaleString() : 'Date à déterminer'}</p>
                `;
                avisList.appendChild(avisElement);
            });

            // Afficher la prochaine intervention en haut de la liste
            if (prochaineIntervention) {
                const prochaineInterventionElement = document.createElement('div');
                prochaineInterventionElement.className = 'avis prochaine-intervention';
                prochaineInterventionElement.innerHTML = `
                    <h3>Prochaine intervention prévue</h3>
                    <p>Date et heure : ${prochaineIntervention.toLocaleString()}</p>
                `;
                avisList.insertBefore(prochaineInterventionElement, avisList.firstChild);
            }

            // Afficher l'intervention à prévoir si nécessaire
            if (interventionAPrevoir) {
                const aPrevoirElement = document.createElement('div');
                aPrevoirElement.className = 'avis a-prevoir';
                aPrevoirElement.innerHTML = `
                    <h3>Intervention à prévoir</h3>
                    <p>La prochaine intervention est à prévoir. Nous vous contacterons pour fixer une date.</p>
                `;
                avisList.insertBefore(aPrevoirElement, avisList.firstChild);
            }
        }

        document.getElementById('typeIntervention').addEventListener('change', function() {
            const dateInterventionField = document.getElementById('dateIntervention');
            if (this.value === 'aPrevoir') {
                dateInterventionField.removeAttribute('required');
                dateInterventionField.style.display = 'none';
            } else {
                dateInterventionField.setAttribute('required', '');
                dateInterventionField.style.display = 'block';
            }
        });

        document.getElementById('avisForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const clientId = getClientId();
            const avisData = {
                date: document.getElementById('date').value,
                heureDebut: document.getElementById('heureDebut').value,
                heureFin: document.getElementById('heureFin').value,
                observations: document.getElementById('observations').value,
                intervenant: document.getElementById('intervenant').value,
                typeIntervention: document.getElementById('typeIntervention').value,
                dateIntervention: document.getElementById('dateIntervention').value || null
            };

            const avis = JSON.parse(localStorage.getItem(`avis_${clientId}`)) || [];
            avis.push(avisData);
            localStorage.setItem(`avis_${clientId}`, JSON.stringify(avis));

            loadAvis();
            document.getElementById('avisForm').reset();
            alert('Avis de passage ajouté avec succès.');
        });

        loadAvis();
    </script>
</body>
</html>
